<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height,initial-scale=0.6, minimum-scale=0.6, maximum-scale=0.6"
    />
    <title>Table Display</title>
    <!-- font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- canvasjs -->
    <script
      type="text/javascript"
      src="https://cdn.canvasjs.com/canvasjs.min.js"
    ></script>

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- autocomplete jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

    <!-- sweetalert2 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.8/sweetalert2.all.js"
      integrity="sha512-mDHahYvyhRtp6zBGslYxaLlAiINPDDEoHDD7nDsHoLtua4To71lDTHjDL1bCoAE/Wq/I+7ONeFMpgr62i5yUzw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"
    />

    <?!= include('CSS'); ?>
  </head>

  <body>
    <!-- loading data -->
    <div class="loading-data">
      <div class="loader">
        <div class="loader_overlay"></div>
        <div class="loader_cogs">
          <div class="loader_cogs__top">
            <div class="top_part"></div>
            <div class="top_part"></div>
            <div class="top_part"></div>
            <div class="top_hole"></div>
          </div>
          <div class="loader_cogs__left">
            <div class="left_part"></div>
            <div class="left_part"></div>
            <div class="left_part"></div>
            <div class="left_hole"></div>
          </div>
          <div class="loader_cogs__bottom">
            <div class="bottom_part"></div>
            <div class="bottom_part"></div>
            <div class="bottom_part"></div>
            <div class="bottom_hole"></div>
          </div>
          <p>กำลังโหลดข้อมูล</p>
        </div>
      </div>
    </div>

    <!-- loading edit -->
    <div class="loading-edit">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        height="200px"
        width="200px"
        viewBox="0 0 200 200"
        class="pencil"
      >
        <defs>
          <clippath id="pencil-eraser">
            <rect height="30" width="30" ry="5" rx="5"></rect>
          </clippath>
        </defs>
        <circle
          transform="rotate(-113,100,100)"
          stroke-linecap="round"
          stroke-dashoffset="439.82"
          stroke-dasharray="439.82 439.82"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          r="70"
          class="pencil-stroke"
        ></circle>
        <g transform="translate(100,100)" class="pencil-rotate">
          <g fill="none" class="pencil-body">
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="402"
              stroke-dasharray="402.12 402.12"
              stroke-width="30"
              stroke="hsl(223,90%,50%)"
              r="64"
              class="pencil-body1"
            ></circle>
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="465"
              stroke-dasharray="464.96 464.96"
              stroke-width="10"
              stroke="hsl(223,90%,60%)"
              r="74"
              class="pencil-body2"
            ></circle>
            <circle
              transform="rotate(-90)"
              stroke-dashoffset="339"
              stroke-dasharray="339.29 339.29"
              stroke-width="10"
              stroke="hsl(223,90%,40%)"
              r="54"
              class="pencil-body3"
            ></circle>
          </g>
          <g transform="rotate(-90) translate(49,0)" class="pencil-eraser">
            <g class="pencil-eraser-skew">
              <rect
                height="30"
                width="30"
                ry="5"
                rx="5"
                fill="hsl(223,90%,70%)"
              ></rect>
              <rect
                clip-path="url(#pencil-eraser)"
                height="30"
                width="5"
                fill="hsl(223,90%,60%)"
              ></rect>
              <rect height="20" width="30" fill="hsl(223,10%,90%)"></rect>
              <rect height="20" width="15" fill="hsl(223,10%,70%)"></rect>
              <rect height="20" width="5" fill="hsl(223,10%,80%)"></rect>
              <rect
                height="2"
                width="30"
                y="6"
                fill="hsla(223,10%,10%,0.2)"
              ></rect>
              <rect
                height="2"
                width="30"
                y="13"
                fill="hsla(223,10%,10%,0.2)"
              ></rect>
            </g>
          </g>
          <g transform="rotate(-90) translate(49,-30)" class="pencil-point">
            <polygon points="15 0,30 30,0 30" fill="hsl(33,90%,70%)"></polygon>
            <polygon points="15 0,6 30,0 30" fill="hsl(33,90%,50%)"></polygon>
            <polygon
              points="15 0,20 10,10 10"
              fill="hsl(223,10%,10%)"
            ></polygon>
          </g>
        </g>
      </svg>
    </div>

    <!-- loading page -->
    <div class="loading-page">
      <section class="loader">
        <div class="slider" style="--i: 0"></div>
        <div class="slider" style="--i: 1"></div>
        <div class="slider" style="--i: 2"></div>
        <div class="slider" style="--i: 3"></div>
        <div class="slider" style="--i: 4"></div>

        <!-- <span>กำลังอัพเดทข้อมูล</span> -->
      </section>
    </div>

    <!-- loading trash -->
    <div class="loading-trash">
      <section>
        <span class="trash">
          <span></span>
          <i></i>
        </span>
      </section>
    </div>

    <!-- login -->
    <?!= include('login'); ?>

    <main class="d-none main-pages">
      <nav class="navbar bg-primary sticky-top py-1">
        <div class="container-fluid">
          <a class="navbar-brand text-white fw-bold fs-2 ms-2">Polipharm</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#sidebar_menu"
            aria-controls="sidebar_menu"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div
            class="offcanvas offcanvas-end"
            tabindex="-1"
            id="sidebar_menu"
            aria-labelledby="sidebarLabel"
          >
            <div class="offcanvas-header">
              <h4
                class="offcanvas-title fw-bolder text-decoration-underline"
                id="sidebarLabel"
              >
                โปรแกรมบันทึกข้อมูลน้ำหนักยา
              </h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"
              ></button>
            </div>
            <div class="offcanvas-body" id="sidebar_body"></div>
            <footer class="d-flex flex-row m-2">
              <input type="hidden" name="logout" value="logout" />
              <button type="button" id="logout" class="btn btn-danger">
                ออกจากระบบ
              </button>
            </footer>
          </div>
        </div>
      </nav>

      <section class="pages container-xxl">
        <div class="page active" data-toggle="home_page">
          <div class="page-main-container">
            <div id="home_page" class="page-container">
              <p class="page-title">ยินดีต้อนรับคุณ สิทธิการใช้งาน</p>
              <iframe
                style="border: none"
                src="https://whimsical.com/embed/RLsLUSn5w5v9VKw5bFDJbM"
              ></iframe>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="weight_10s_page">
          <p class="page-title">ตารางข้อมูลน้ำหนักยา 10 เม็ด</p>
          <div id="container10s" class="weight-container"></div>
        </div>

        <div class="page" data-toggle="weight_ipc_page">
          <p class="page-title">
            การควบคุมน้ำหนักเฉลี่ย (AVERAGE WEIGHT)
            <br />
            และน้ำหนักเบี่ยงเบนของเม็ดยา (WEIGHT VARIATION)
          </p>
          <div id="containerIpc" class="weight-container"></div>
        </div>

        <div class="page" data-toggle="weighing_setup_page">
          <div class="form-main-container">
            <div id="weighing_setup" class="form-container">
              <p class="page-title">ตั้งค่าน้ำหนักยาของเครื่องตอก</p>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="weighing_database_page">
          <div class="form-main-container">
            <div id="weighing_database" class="form-container">
              <p class="page-title">แก้ไขฐานข้อมูลน้ำหนักยา</p>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="user_database_page">
          <div class="form-main-container">
            <div id="user_edit" class="form-container">
              <p class="page-title">แก้ไขรายชื่อผู้ปฏิบัติงาน</p>

              <div class="form-detail">
                <ol>
                  <li class="lh-lg">
                    ต้องการแก้ไขข้อมูลให้ทำการเลือกที่ รายชือพนักงาน
                  </li>
                  <li class="lh-lg">
                    ต้องการเพิ่มข้อมูลให้กรอกข้อมูลแล้วกดบันทึก
                  </li>
                  <li class="lh-lg">
                    ต้องการลบข้อมูลให้ทำการเลือกที่ รายชือพนักงาน
                    แล้วกดลบผู้ใช้งาน
                  </li>
                  <li class="lh-lg">ต้องการเคลียร์ฟอร์มกดยกเลิก</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <div class="page" data-toggle="data_logging_page">
          <p class="page-title">บันทึกการปฏิบัติงาน</p>
          <div id="data_logging" class="dataLogging-container"></div>
        </div>
      </section>
    </main>

    <!-- ตั้งค่า DataTable -->
    <script>
      const setupTable = {
        // กำหนดเมนูแสดงจำนวนแถว
        lengthMenu: [
          [5, 10, 15, 20, 50, 100, -1],
          ["5", "10", "15", "20", "50", "100", "ทั้งหมด"],
        ],

        // columnDefs: [
        //     { "orderable": false, "targets": [1, 2, 3, 4, 5, 6] },
        // ],

        ordering: false,
        // order: [[0, "desc"]],
        iDisplayLength: 10,
        responsive: true,

        //ภาษาไทย
        language: {
          sLengthMenu: "แสดง _MENU_ รายการ",
          sZeroRecords: "ไม่พบข้อมูล",
          sInfo: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
          sInfoEmpty: "แสดง 0 ถึง 0 จาก 0 รายการ",
          sInfoFiltered: "(กรองข้อมูลจาก _MAX_ รายการ)",
          sInfoPostFix: "",
          sSearch: "ค้นหา:",
          sUrl: "",
          oPaginate: {
            sFirst: "หน้าแรก",
            sPrevious: "ก่อนหน้า",
            sNext: "ถัดไป",
            sLast: "หน้าสุดท้าย",
          },
        },
      };

      // // จัดเรียงข้อมูล DataTable ตามวันที่มากไปน้อย
      // $(document).ready(function () {
      //   DataTable.datetime("DD/MM/YYYY, HH:mm:ss");
      // });
    </script>

    <?!= include('JS'); ?>

    <!-- สร้างเมนูตามสิทธิ์การใช้งาน, ออกจากระบบ -->
    <script>
      function createSidebarMenu(userData) {
        const welcomeEl = document.querySelector("#home_page>.page-title");
        welcomeEl.innerHTML = `ยินดีต้อนรับคุณ ${userData.nameTH} สิทธิการใช้งาน ${userData.role}`;
        const sidebar_body = document.getElementById("sidebar_body");
        const menu_lists = new CreateSidebarMenu(userData.role);
        sidebar_body.appendChild(menu_lists.lists);

        const sidebar_menu = new bootstrap.Offcanvas("#sidebar_menu");

        // ซ่อนและแสดงหน้า
        $(".page-menu").on("click", function () {
          sidebar_menu.hide();
          const currentPage = $(this).attr("data-toggle");
          $(".pages>.page").each(function () {
            const page = $(this).attr("data-toggle");
            if (currentPage === page) {
              $(this).fadeIn(500);
              $(this).addClass("active");
              window.scrollTo(0, 0);
            } else {
              $(this).removeClass("active");
              $(this).hide();
            }
          });
        });

        // สร้างหน้าข้อมูลการชั่งน้ำหนัก 10 เม็ด
        $(menu_lists.page2_menu).on("click", function () {
          createWeighing10sDataPage();
        });

        // สร้างหน้าข้อมูลการชั่งน้ำหนัก ipc
        $(menu_lists.page3_menu).on("click", function () {
          createWeighingIpcDataPage();
        });

        // สร้างหน้าตั้งค่าน้ำหนักยาของเครื่องตอก
        $(menu_lists.page4_menu).on("click", function () {
          createWeighingSetupAndEdit();
        });

        // สร้างหน้าแก้ไขฐานข้อมูลน้ำหนักยา
        $(menu_lists.page5_menu).on("click", function () {
          createWeighingSetupAndEdit();
        });

        // สร้างหน้าแก้ไขรายชื่อผู้ปฏิบัติงาน
        $(menu_lists.page6_menu).on("click", function () {
          createEditUserData();
        });

        // สร้างหน้าบันทึกการปฏิบัติงาน
        $(menu_lists.page7_menu).on("click", function () {
          createDataLogging();
        });
      }

      // ออกจากระบบ
      $("#logout").click(logout);

      function logout() {
        localStorage.clear();
        const link = document.createElement("a");
        link.href = "<?!= getUrl(); ?>";
        link.click();
      }

      // Refresh token
      function refreshToken(jsonWebToken) {
        localStorage.setItem(
          storageKey.jsonWebToken,
          jsonWebToken
        );
      }
    </script>

    <!-- สร้างหน้าชั่งน้ำหนัก 10 เม็ด(สิทธิ์การใช้งาน) -->
    <script>
      let createWeighing10sDataPageState = false;
      function createWeighing10sDataPage() {
        // Create an instance of Table10s
        if (!createWeighing10sDataPageState) {
          loadingData("show");
          const weight10s = new Weighing10s("container10s", {
            setupTable: setupTable,

            // ข้อมูลการชั่งน้ำหนัก 10 เม็ด
            weighing: {
              weighingID: "weight_10s",
              weigtingTitle:
                "ตารางบันทึกบันทึกค่าน้ำหนัก 10 เม็ด 2 ครั้งทุก 30 นาที",
              weigtingHeaders: [
                { timestamp: "วันที่,เวลา" },
                { type: "TYPE" },
                { weight1: "ครั้งที่ 1" },
                { weight2: "ครั้งที่ 2" },
                { average: "นน.เฉลี่ย" },
                { percent: "%นน.เฉลี่ย" },
                { characteristics: "ลักษณะเม็ด" },
                { operator: "ผู้ปฏิบัติ" },
                { inspector: "ผู้ตรวจสอบ" },
              ],

              thicknessID: "thickness_10s",
              thicknessTitle: "ตารางบันทึกค่าความหนาของเม็ดยา ทุก 2 ชั่วโมง",
              thicknessHeaders: [
                { timestamp: "วันที่,เวลา" },
                { thickness1: "1" },
                { thickness2: "2" },
                { thickness3: "3" },
                { thickness4: "4" },
                { thickness5: "5" },
                { thickness6: "6" },
                { thickness7: "7" },
                { thickness8: "8" },
                { thickness9: "9" },
                { thickness10: "10" },
              ],
            },

            // Remarks
            remarks: {
              id: "remarks_weight_10s",
              title: "Remarks",
              headers: [
                { timestamp: "วันที่/เวลา" },
                { issues: "เหตุการที่เกิดการเปลี่ยนแปลง" },
                { cause: "สาเหตุ" },
                { resolve: "การแก้ไข" },
                { recorder: "ผู้บันทึก" },
                { role: "สิทธิ์" },
              ],
            },
          });
          
          weight10s.updateProductionLists();
          createWeighing10sDataPageState = true;
        }
      }
    </script>

    <!-- สร้างหน้าชั่งน้ำหนัก ipc(สิทธิ์การใช้งาน) -->
    <script>
      let createWeighingIpcDataPageState = false;
      function createWeighingIpcDataPage() {
        // Create an instance of ipc
        if (!createWeighingIpcDataPageState) {
          loadingData("show");
          const weightIpc = new WeighingIpc("containerIpc", {
            setupTable: setupTable,

            // ข้อมูลการชั่งน้ำหนัก 10 เม็ด
            weighing: {
              weighingID: "weight_ipc",
            },

            // Remarks
            remarks: {
              id: "remarks_weight_ipc",
              title: "Remarks",
              headers: [
                { timestamp: "วันที่/เวลา" },
                { issues: "เหตุการที่เกิดการเปลี่ยนแปลง" },
                { cause: "สาเหตุ" },
                { resolve: "การแก้ไข" },
                { recorder: "ผู้บันทึก" },
                { role: "สิทธิ์" },
              ],
            },
          });

          weightIpc.updateProductionLists();
          createWeighingIpcDataPageState = true;
        }
      }
    </script>

    <!-- สร้างหน้าตั้งค่าน้ำหนักยาของเครื่องตอก, แก้ไขฐานข้อมูลน้ำหนักยา -->
    <script>
      let createWeighingSetupAndEditState = false;
      function createWeighingSetupAndEdit() {
        if (!createWeighingSetupAndEditState) {
          // สร้างฟอร์มตั้งค่าน้ำหนักยาของเครื่องตอก
          const form_weighing_setup = new CreateForm("weighing_setup");

          // สร้างฟอร์มแก้ไขฐานข้อมูลน้ำหนักยา
          const form_weighing_database = new CreateForm("weighing_database");

          loadingData("show");

          google.script.run
            .withSuccessHandler(({ result, dataSettings }) => {
              // สร้างฟอร์มตั้งค่าน้ำหนักยาของเครื่องตอก
              if (result.message === "success") {
                refreshToken(result.jsonWebToken);
                form_weighing_setup.createSetupForm(dataSettings);

                // สร้างฟอร์มแก้ไขฐานข้อมูลน้ำหนักยา
                form_weighing_database.createEditForm(dataSettings);
                loadingData("hide");
              } else {
                console.log(result.message);
                logout();
              }
            })
            .getDataSetting(localStorage.getItem(storageKey.jsonWebToken));
        }

        createWeighingSetupAndEditState = true;
      }
    </script>

    <!-- สร้างหน้าแก้ไขรายชื่อผู้ปฏิบัติงาน -->
    <script>
      let createEditUserDataState = false;

      function createEditUserData() {
        // สร้างฟอร์มแก้ไขรายชื่อผู้ปฏิบัติงาน
        if (!createEditUserDataState) {
          const form_userData = new CreateUserDataForm("user_edit");
          form_userData.createFormUserData();
          createEditUserDataState = true;
        }
      }
    </script>

    <!-- สร้างหน้าบันทึกการปฏิบัติงาน -->
    <script>
      let createDataLoggingState = false;
      function createDataLogging() {
        if (!createDataLoggingState) {
          const dataLogging = new CreateDataLogging("data_logging", {
            setupTable: setupTable,
            title: "บันทึกการปฎิบัติงาน",
            tableId: "dataLoggingTable",
            headers: {
              datetime: "วันที่/เวลา",
              list: "รายการ",
              details: "รายละเอียด",
              recorder: "ผู้บันทึก",
              role: "สิทธิ์การเข้าถึง",
            },
          });

          loadingData("show");
          google.script.run
            .withSuccessHandler(({ result, dataset }) => {
              loadingData("hide");
              if (result.message === "success") {
                refreshToken(result.jsonWebToken);
                dataLogging.render(dataset);
              } else {
                console.log(result.message);
                logout();
              }
            })
            .getAuditTrailData(localStorage.getItem(storageKey.jsonWebToken));

          createDataLoggingState = true;
        }
      }
    </script>

    <!-- loading, success, failed -->
    <script>
      function loadingPage(command) {
        switch (command) {
          case "show":
            $(".loading-page").fadeIn();
            break;
          case "hide":
            $(".loading-page").fadeOut();
            break;
          default:
            $(".loading-page").hide();
            break;
        }
      }

      function loadingTrash(command) {
        switch (command) {
          case "show":
            $(".loading-trash").fadeIn();
            break;
          case "hide":
            $(".loading-trash").fadeOut();
            break;
          default:
            $(".loading-trash").hide();
            break;
        }
      }

      function loadingEdit(command) {
        switch (command) {
          case "show":
            $(".loading-edit").fadeIn();
            break;
          case "hide":
            $(".loading-edit").fadeOut();
            break;
          default:
            $(".loading-edit").hide();
            break;
        }
      }

      function loadingData(command) {
        switch (command) {
          case "show":
            $(".loading-data").fadeIn();
            break;
          case "hide":
            $(".loading-data").fadeOut();
            break;
          default:
            $(".loading-data").hide();
            break;
        }
      }

      const SwalPopup = Swal.mixin({
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ยืนยัน, ลบข้อมูล!",
        cancelButtonText: "ยกเลิก",
      });

      const SwalAlert = Swal.mixin({
        title: "ดำเนินการเรียบร้อย",
        icon: "success",
        showConfirmButton: false,
        timer: 2500,
      });

      const SwalMiniAlert = Swal.mixin({
        toast: true,
        icon: "success",
        title: "ดำเนินการเรียบร้อยแล้ว",
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
      });
    </script>

    <!--Js Datatable-->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

    <!--Js Bootstrap-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"
      integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </body>
</html>
